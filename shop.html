<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - DeepProTeam Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Navigation (include from base) -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <a href="/" class="text-2xl font-bold text-blue-600">DeepProTeam</a>
                </div>
                <div class="flex-1 mx-8 hidden md:block">
                    <input type="text" id="searchInput" placeholder="Search products..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center gap-4">
                    <a href="/cart.html" class="text-gray-700 hover:text-blue-600 relative">
                        <i class="fas fa-shopping-cart text-xl"></i>
                        <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center" id="cartCount">0</span>
                    </a>
                    <div class="relative" id="userMenu">
                        <button class="flex items-center gap-2 text-gray-700 hover:text-blue-600">
                            <i class="fas fa-user-circle text-xl"></i>
                            <span id="userDisplay">Login</span>
                        </button>
                        <div id="userDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg">
                            <a href="/login.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Login</a>
                            <a href="/register.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Register</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Shop</h1>
            <p class="text-gray-600">Browse our collection of quality products</p>
        </div>

        <!-- Filters & Products -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Sidebar Filters -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow p-6 sticky top-20">
                    <h3 class="font-bold text-lg mb-4">Filters</h3>

                    <!-- Categories -->
                    <div class="mb-6">
                        <h4 class="font-semibold mb-3 text-gray-900">Categories</h4>
                        <div id="categoriesList" class="space-y-2">
                            <!-- Filled by JS -->
                        </div>
                    </div>

                    <!-- Price Range -->
                    <div class="mb-6">
                        <h4 class="font-semibold mb-3 text-gray-900">Price Range (EGP)</h4>
                        <input type="range" min="0" max="10000" value="5000" id="priceRange" 
                            class="w-full">
                        <p class="text-sm text-gray-600 mt-2">Up to <span id="priceValue">5000</span> EGP</p>
                    </div>

                    <!-- Sort -->
                    <div class="mb-6">
                        <h4 class="font-semibold mb-3 text-gray-900">Sort By</h4>
                        <select id="sortSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="-created_at">Newest</option>
                            <option value="price_egp">Price: Low to High</option>
                            <option value="-price_egp">Price: High to Low</option>
                            <option value="-rating">Rating</option>
                        </select>
                    </div>

                    <button id="resetFilters" class="w-full py-2 px-4 bg-gray-200 text-gray-900 rounded-lg hover:bg-gray-300">
                        Reset Filters
                    </button>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="lg:col-span-3">
                <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Filled by JS -->
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="col-span-full text-center py-12">
                    <div class="inline-block">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                    </div>
                    <p class="text-gray-600 mt-4">Loading products...</p>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="col-span-full text-center py-12 hidden">
                    <i class="fas fa-box-open text-gray-400 text-6xl mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">No products found</h3>
                    <p class="text-gray-600">Try adjusting your filters</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div id="productModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-96 overflow-y-auto">
            <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                <h2 id="modalTitle" class="text-2xl font-bold"></h2>
                <button onclick="document.getElementById('productModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modalBody" class="p-6">
                <!-- Product details filled by JS -->
            </div>
            <div class="border-t p-6 bg-gray-50">
                <button id="addToCartBtn" class="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                    Add to Cart
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let authToken = localStorage.getItem('access_token');
        let currentProduct = null;
        let filters = {
            search: '',
            category: null,
            ordering: '-created_at'
        };

        // Fetch and display categories
        async function loadCategories() {
            try {
                const res = await fetch(`${API_BASE}/shop/categories/`);
                const categories = await res.json();
                const list = document.getElementById('categoriesList');
                list.innerHTML = categories.results.map(cat => `
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" value="${cat.id}" class="category-filter mr-2" />
                        <span class="text-gray-700">${cat.name}</span>
                    </label>
                `).join('');

                document.querySelectorAll('.category-filter').forEach(el => {
                    el.addEventListener('change', () => {
                        const selected = Array.from(document.querySelectorAll('.category-filter:checked'))
                            .map(el => el.value);
                        filters.category = selected.length > 0 ? selected[0] : null;
                        loadProducts();
                    });
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Fetch and display products
        async function loadProducts() {
            const loading = document.getElementById('loadingState');
            const empty = document.getElementById('emptyState');
            const grid = document.getElementById('productsGrid');

            loading.classList.remove('hidden');
            empty.classList.add('hidden');
            grid.innerHTML = '';

            try {
                let url = `${API_BASE}/shop/products/?ordering=${filters.ordering}`;
                if (filters.search) url += `&search=${filters.search}`;
                if (filters.category) url += `&category=${filters.category}`;

                const res = await fetch(url);
                const data = await res.json();
                const products = data.results || [];

                if (products.length === 0) {
                    empty.classList.remove('hidden');
                } else {
                    grid.innerHTML = products.map(product => `
                        <div class="bg-white rounded-lg shadow hover:shadow-lg transition cursor-pointer" onclick="showProductModal('${product.slug}')">
                            <div class="aspect-video bg-gray-200 overflow-hidden rounded-t-lg">
                                <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover hover:scale-110 transition">
                            </div>
                            <div class="p-4">
                                <p class="text-sm text-gray-500 mb-1">${product.category.name}</p>
                                <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2">${product.name}</h3>
                                <div class="flex justify-between items-center mb-3">
                                    <div class="flex gap-1">
                                        <i class="fas fa-star text-yellow-400"></i>
                                        <span class="text-sm font-medium">${product.avg_rating ? product.avg_rating.toFixed(1) : 'N/A'}</span>
                                        <span class="text-sm text-gray-500">(${product.review_count})</span>
                                    </div>
                                    <span class="text-blue-600 font-bold">${product.price_egp} EGP</span>
                                </div>
                                <button onclick="addToCart(event, ${product.id})" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading products:', error);
                grid.innerHTML = '<p class="text-red-600">Error loading products</p>';
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Show product details modal
        async function showProductModal(slug) {
            try {
                const res = await fetch(`${API_BASE}/shop/products/${slug}/`);
                const product = await res.json();
                currentProduct = product;

                document.getElementById('modalTitle').textContent = product.name;
                document.getElementById('modalBody').innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <img src="${product.image}" alt="${product.name}" class="w-full rounded-lg">
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold mb-2">${product.name}</h3>
                            <p class="text-gray-600 mb-4">${product.description}</p>
                            <div class="mb-6">
                                <div class="inline-block bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full">
                                    <i class="fas fa-star text-yellow-400 mr-1"></i>
                                    ${product.avg_rating ? product.avg_rating.toFixed(1) : 'No ratings'} (${product.review_count} reviews)
                                </div>
                            </div>
                            <div class="space-y-2 mb-6">
                                ${product.price_egp ? `<p class="text-lg"><strong>EGP:</strong> ${product.price_egp} EGP</p>` : ''}
                                ${product.price_gold ? `<p class="text-lg"><strong>Gold:</strong> ${product.price_gold} Gold</p>` : ''}
                                ${product.price_mass ? `<p class="text-lg"><strong>Mass:</strong> ${product.price_mass} Mass</p>` : ''}
                            </div>
                            <p class="text-gray-600 mb-4">
                                <strong>Stock:</strong> ${product.stock} available
                            </p>
                        </div>
                    </div>
                `;

                document.getElementById('productModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading product:', error);
            }
        }

        // Add to cart
        async function addToCart(event, productId) {
            event.stopPropagation();
            
            if (!authToken) {
                alert('Please login to add items to cart');
                window.location.href = '/login.html';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/orders/cart/add_item/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ product_id: productId, quantity: 1 })
                });

                if (res.ok) {
                    alert('Product added to cart');
                    updateCartCount();
                } else {
                    alert('Error adding to cart');
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
            }
        }

        // Update cart count
        async function updateCartCount() {
            if (!authToken) return;
            try {
                const res = await fetch(`${API_BASE}/orders/cart/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const cart = await res.json();
                const count = cart.items?.length || 0;
                document.getElementById('cartCount').textContent = count;
            } catch (error) {
                console.error('Error updating cart count:', error);
            }
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', (e) => {
            filters.search = e.target.value;
            loadProducts();
        });

        document.getElementById('sortSelect').addEventListener('change', (e) => {
            filters.ordering = e.target.value;
            loadProducts();
        });

        document.getElementById('priceRange').addEventListener('input', (e) => {
            document.getElementById('priceValue').textContent = e.target.value;
        });

        document.getElementById('resetFilters').addEventListener('click', () => {
            filters = { search: '', category: null, ordering: '-created_at' };
            document.getElementById('searchInput').value = '';
            document.getElementById('sortSelect').value = '-created_at';
            document.querySelectorAll('.category-filter').forEach(el => el.checked = false);
            loadProducts();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadProducts();
            updateCartCount();
        });
        
    </script>

    <script>
const token = localStorage.getItem('access_token');
if (!token) {
  window.location.href = '../login.html';
} else {
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    const exp = payload.exp * 1000;
    if (Date.now() > exp) {
      localStorage.removeItem('access_token');
      localStorage.removeItem('refresh_token');
      window.location.href = '../login.html';
    }
  } catch(e) {
    localStorage.removeItem('access_token');
    localStorage.removeItem('refresh_token');
    window.location.href = '../login.html';
  }
}
</script>

</body>
</html>
