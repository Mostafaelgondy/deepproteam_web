<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet & Shop - DeepProTeam Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <a href="/" class="text-2xl font-bold text-blue-600">DeepProTeam</a>
                </div>
                <div class="flex items-center gap-4">
                    <a href="/shop.html" class="text-gray-700 hover:text-blue-600">
                        <i class="fas fa-store text-xl mr-2"></i>Shop
                    </a>
                    <a href="/cart.html" class="text-gray-700 hover:text-blue-600 relative">
                        <i class="fas fa-shopping-cart text-xl"></i>
                    </a>
                    <div class="relative" id="userMenu">
                        <button class="flex items-center gap-2 text-gray-700 hover:text-blue-600">
                            <i class="fas fa-user-circle text-xl"></i>
                            <span id="userDisplay">Account</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Wallet & Shop</h1>
            <p class="text-gray-600">Manage your balance and purchase virtual assets</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Wallet Balances -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-6">Your Wallet</h2>

                    <!-- EGP -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-gray-900">Egyptian Pound</span>
                            <i class="fas fa-pound-sign text-2xl text-green-600"></i>
                        </div>
                        <p class="text-3xl font-bold text-green-600" id="egpBalance">0.00</p>
                        <p class="text-sm text-gray-600 mt-1">EGP</p>
                    </div>

                    <!-- Gold -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-yellow-50 to-amber-50 rounded-lg border border-yellow-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-gray-900">Gold (Premium)</span>
                            <i class="fas fa-crown text-2xl text-yellow-600"></i>
                        </div>
                        <p class="text-3xl font-bold text-yellow-600" id="goldBalance">0.00</p>
                        <p class="text-sm text-gray-600 mt-1">Gold</p>
                    </div>

                    <!-- Mass -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border border-blue-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-gray-900">Mass (Regular)</span>
                            <i class="fas fa-box text-2xl text-blue-600"></i>
                        </div>
                        <p class="text-3xl font-bold text-blue-600" id="massBalance">0.00</p>
                        <p class="text-sm text-gray-600 mt-1">Mass</p>
                    </div>

                    <!-- Refresh -->
                    <button id="refreshBalance" class="w-full py-2 px-4 bg-gray-200 text-gray-900 rounded-lg hover:bg-gray-300">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>

                <!-- Conversion Rates -->
                <div class="bg-white rounded-lg shadow p-6 mt-6">
                    <h2 class="text-xl font-bold mb-4">Exchange Rates</h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">1 EGP =</span>
                            <span class="font-semibold" id="rateGold">10 Gold</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">1 EGP =</span>
                            <span class="font-semibold" id="rateMass">5 Mass</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">1 Gold =</span>
                            <span class="font-semibold" id="rateGoldToMass">0.5 Mass</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buy Gold & Mass -->
            <div class="lg:col-span-2">
                <!-- Buy Gold -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex items-center mb-6">
                        <i class="fas fa-crown text-4xl text-yellow-500 mr-4"></i>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Buy Gold</h2>
                            <p class="text-gray-600">Premium virtual currency</p>
                        </div>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                        <p class="text-sm text-gray-700 mb-2">Gold Benefits:</p>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li><i class="fas fa-check text-green-600 mr-2"></i>Premium features</li>
                            <li><i class="fas fa-check text-green-600 mr-2"></i>Faster deliveries</li>
                            <li><i class="fas fa-check text-green-600 mr-2"></i>VIP support</li>
                        </ul>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-900 mb-2">Amount in EGP</label>
                            <input type="number" id="goldEgpAmount" min="1" value="100" placeholder="Enter amount" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-600">You will receive:</span>
                                <span class="font-bold text-yellow-600" id="goldReceiveCalc">1000 Gold</span>
                            </div>
                            <div class="text-sm text-gray-600">At rate of 1 EGP = <span id="goldRateDisplay">10</span> Gold</div>
                        </div>
                        <button id="buyGoldBtn" class="w-full py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold flex items-center justify-center gap-2">
                            <i class="fas fa-shopping-cart"></i>
                            Buy Gold Now
                        </button>
                    </div>
                </div>

                <!-- Buy Mass -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center mb-6">
                        <i class="fas fa-box text-4xl text-blue-500 mr-4"></i>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Buy Mass</h2>
                            <p class="text-gray-600">Regular virtual currency</p>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <p class="text-sm text-gray-700 mb-2">Mass Benefits:</p>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li><i class="fas fa-check text-green-600 mr-2"></i>Standard features</li>
                            <li><i class="fas fa-check text-green-600 mr-2"></i>Regular updates</li>
                            <li><i class="fas fa-check text-green-600 mr-2"></i>Community support</li>
                        </ul>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-900 mb-2">Amount in EGP</label>
                            <input type="number" id="massEgpAmount" min="1" value="100" placeholder="Enter amount" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-600">You will receive:</span>
                                <span class="font-bold text-blue-600" id="massReceiveCalc">500 Mass</span>
                            </div>
                            <div class="text-sm text-gray-600">At rate of 1 EGP = <span id="massRateDisplay">5</span> Mass</div>
                        </div>
                        <button id="buyMassBtn" class="w-full py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold flex items-center justify-center gap-2">
                            <i class="fas fa-shopping-cart"></i>
                            Buy Mass Now
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="bg-white rounded-lg shadow mt-8 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900">Recent Transactions</h2>
            </div>
            <div id="transactionsList" class="divide-y">
                <!-- Filled by JS -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        const authToken = localStorage.getItem('access_token');

        if (!authToken) {
            alert('Please login first');
            window.location.href = '/login.html';
        }

        async function loadWallet() {
            try {
                const res = await fetch(`${API_BASE}/auth/wallet/balance/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const wallet = await res.json();
                document.getElementById('egpBalance').textContent = wallet.egp.toFixed(2);
                document.getElementById('goldBalance').textContent = wallet.gold.toFixed(2);
                document.getElementById('massBalance').textContent = wallet.mass.toFixed(2);
            } catch (error) {
                console.error('Error loading wallet:', error);
                alert('Error loading wallet balance');
            }
        }

        async function loadRates() {
            try {
                const res = await fetch(`${API_BASE}/payments/shop/rates/`);
                const rates = await res.json();
                document.getElementById('rateGold').textContent = `${rates.egp_to_gold} Gold`;
                document.getElementById('rateMass').textContent = `${rates.egp_to_mass} Mass`;
                document.getElementById('rateGoldToMass').textContent = `${(rates.egp_to_mass / rates.egp_to_gold).toFixed(2)} Mass`;
                document.getElementById('goldRateDisplay').textContent = rates.egp_to_gold;
                document.getElementById('massRateDisplay').textContent = rates.egp_to_mass;
                return rates;
            } catch (error) {
                console.error('Error loading rates:', error);
            }
        }

        async function loadTransactions() {
            try {
                const res = await fetch(`${API_BASE}/payments/transactions/?ordering=-created_at&limit=10`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                const list = document.getElementById('transactionsList');
                
                if (data.results?.length === 0) {
                    list.innerHTML = '<div class="px-6 py-4 text-gray-600">No transactions yet</div>';
                    return;
                }

                list.innerHTML = data.results?.map(txn => `
                    <div class="px-6 py-4 hover:bg-gray-50 transition">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-900">${txn.description}</p>
                                <p class="text-sm text-gray-600">${new Date(txn.created_at).toLocaleString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold ${txn.transaction_type === 'refund' ? 'text-green-600' : 'text-red-600'}">
                                    ${txn.transaction_type === 'refund' ? '+' : '-'}${txn.amount.toFixed(2)} ${txn.currency.toUpperCase()}
                                </p>
                                <span class="text-xs ${txn.status === 'completed' ? 'text-green-600' : 'text-yellow-600'}">
                                    ${txn.status}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        async function buyGold() {
            const amount = document.getElementById('goldEgpAmount').value;
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            const btn = document.getElementById('buyGoldBtn');
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                const res = await fetch(`${API_BASE}/payments/shop/buy-gold/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ amount_egp: parseFloat(amount) })
                });

                if (res.ok) {
                    const data = await res.json();
                    alert(`Success! You received ${data.gold_received.toFixed(2)} Gold`);
                    loadWallet();
                    loadTransactions();
                    document.getElementById('goldEgpAmount').value = '100';
                } else {
                    const error = await res.json();
                    alert(error.detail || 'Error purchasing Gold');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error processing purchase');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Buy Gold Now';
            }
        }

        async function buyMass() {
            const amount = document.getElementById('massEgpAmount').value;
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            const btn = document.getElementById('buyMassBtn');
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                const res = await fetch(`${API_BASE}/payments/shop/buy-mass/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ amount_egp: parseFloat(amount) })
                });

                if (res.ok) {
                    const data = await res.json();
                    alert(`Success! You received ${data.mass_received.toFixed(2)} Mass`);
                    loadWallet();
                    loadTransactions();
                    document.getElementById('massEgpAmount').value = '100';
                } else {
                    const error = await res.json();
                    alert(error.detail || 'Error purchasing Mass');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error processing purchase');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Buy Mass Now';
            }
        }

        // Calculate amounts dynamically
        let rates = {};

        document.getElementById('goldEgpAmount').addEventListener('input', (e) => {
            const amount = parseFloat(e.target.value) || 0;
            const gold = amount * rates.egp_to_gold;
            document.getElementById('goldReceiveCalc').textContent = `${gold.toFixed(2)} Gold`;
        });

        document.getElementById('massEgpAmount').addEventListener('input', (e) => {
            const amount = parseFloat(e.target.value) || 0;
            const mass = amount * rates.egp_to_mass;
            document.getElementById('massReceiveCalc').textContent = `${mass.toFixed(2)} Mass`;
        });

        document.getElementById('buyGoldBtn').addEventListener('click', buyGold);
        document.getElementById('buyMassBtn').addEventListener('click', buyMass);
        document.getElementById('refreshBalance').addEventListener('click', loadWallet);

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            loadWallet();
            rates = await loadRates();
            loadTransactions();
            
            // Refresh every 30 seconds
            setInterval(loadWallet, 30000);
        });
        
    </script>

    <script>
const token = localStorage.getItem('access_token');
if (!token) {
  window.location.href = '../login.html';
} else {
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    const exp = payload.exp * 1000;
    if (Date.now() > exp) {
      localStorage.removeItem('access_token');
      localStorage.removeItem('refresh_token');
      window.location.href = '../login.html';
    }
  } catch(e) {
    localStorage.removeItem('access_token');
    localStorage.removeItem('refresh_token');
    window.location.href = '../login.html';
  }
}
</script>

</body>
</html>
